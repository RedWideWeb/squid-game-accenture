<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- iOS home-screen icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="icons/home_screen_icon_180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/home_screen_icon_167.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/home_screen_icon_152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/home_screen_icon_120.png">


    <title>Squid Game Accenture Edition</title>

    <link rel="preload" as="audio" href="sounds/doll_green_light.mp3">
    <link rel="preload" as="audio" href="sounds/doll_red_light.mp3">
    <link rel="preload" as="audio" href="sounds/doll_music.mp3">
    <link rel="preload" as="audio" href="sounds/doll_music_rus.mp3">
    <link rel="preload" as="audio" href="sounds/scan.mp3">
    <link rel="preload" as="audio" href="sounds/round_and_round.mp3">
    <link rel="preload" as="audio" href="sounds/pink_soldiers.mp3">
    <link rel="preload" as="audio" href="sounds/way_back_then.mp3">
    <link rel="preload" as="audio" href="sounds/accomplished.mp3">

    <link rel="manifest" href="manifest.webmanifest">


    <style>
        :root {
            --circle-size: 7.5rem;
            --shine: rgba(255, 255, 255, .35);
            --num-size: 3.5rem;
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: start;
            align-items: center;
            gap: 1.25rem;
            background: #F60078;
            font-family: system-ui, sans-serif;
            color: #eee;
            text-align: center;
            touch-action: manipulation;
        }

        h1 {
            font-size: clamp(0.75rem, 3.5vw, 1.5rem);
            margin-bottom: .25rem;
        }

        .logo {
            margin-top: 64px;
            width: 55vw;
            max-width: 320px;
            height: auto;
            display: block;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            flex-direction: column;
            justify-content: center;
            gap: 1rem;
            max-width: 420px;
            margin-bottom: 40px;
        }

        /* ----- Base button look ----- */
        button.circle, button.pill {
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: clamp(.85rem, 2.8vw, 1rem);
            color: #fff;
            position: relative;
            transition: transform .08s ease-out;
            box-shadow: inset 0 .25rem .5rem rgba(0, 0, 0, .6),
            0 .5rem 1rem rgba(0, 0, 0, .6);
        }

        button.circle:active, button.pill:active {
            transform: scale(.93);
        }

        button.circle::before, button.pill::before {
            content: "";
            position: absolute;
            inset: 10% 14% auto 14%;
            height: 30%;
            border-radius: inherit;
            background: var(--shine);
            filter: blur(.25rem);
            opacity: .9;
            pointer-events: none;
        }

        /* ----- Shape variants ----- */
        .circle {
            width: var(--circle-size);
            height: var(--circle-size);
            border-radius: 50%;
        }

        .pill {
            padding: 1rem 2.25rem;
            border-radius: 8px;
            min-width: 8rem;
        }


        .circle-num {
            width: var(--num-size);
            height: var(--num-size);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid #fffdfd;
            font-weight: 600;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform .07s ease-out;
            -webkit-user-select: none;
            user-select: none;
        }

        #clr {
            color: rgba(255, 255, 255, 0.75);
            border: 2px solid rgba(255, 252, 252, 0.75);
        }

        .circle-num:active {
            transform: scale(.9); /* subtle press */
        }

        .numpad { /* grid uses the new size */
            display: grid;
            grid-template-columns:repeat(3, var(--num-size));
            gap: 1rem;
            justify-content: center;
            margin-bottom: 112px;
            -webkit-user-select: none;
            user-select: none;
        }

        .numpad-display {
            height: 38px;
            font-size: 2rem;
            letter-spacing: .1em;
            min-height: 2.2rem;
            margin-bottom: .5rem;
            -webkit-user-select: none;
            user-select: none;
        }

        .green {
            background: radial-gradient(circle at 30% 30%, #3fff3f 0%, #019a01 70%);
        }

        .red {
            background: radial-gradient(circle at 30% 30%, #ff3c3c 0%, #a00000 70%);
        }

        .blue {
            background: linear-gradient(120deg, #46c8ff 0%, #005b9a 70%);
        }

        .purple {
            background: linear-gradient(120deg, #c180ff 0%, #572d9b 70%);
        }

        .orange {
            background: linear-gradient(120deg, #ffac80 0%, #9b5b2d 70%);
        }

        .grey {
            background: linear-gradient(120deg, #959595 0%, #5c5c5c 70%);
        }

        @media (min-width: 600px) {
            :root {
                --btn-size: 8.5rem;
            }
        }
    </style>
</head>
<body>
<img src="squid_game_logo.png" alt="Squid Game Logo" class="logo">

<h1>Squid Game Accenture Edition</h1>

<div class="row">
    <button id="playBtn" class="circle red"></button>
</div>


<div id="numDisplay" class="numpad-display"></div>

<div class="numpad">
    <button class="circle-num num" data-digit="1">1</button>
    <button class="circle-num num" data-digit="2">2</button>
    <button class="circle-num num" data-digit="3">3</button>

    <button class="circle-num num" data-digit="4">4</button>
    <button class="circle-num num" data-digit="5">5</button>
    <button class="circle-num num" data-digit="6">6</button>

    <button class="circle-num num" data-digit="7">7</button>
    <button class="circle-num num" data-digit="8">8</button>
    <button class="circle-num num" data-digit="9">9</button>

    <span></span>
    <button class="circle-num num" data-digit="0">0</button>
    <button class="circle-num" id="clr">X</button>
</div>


<div class="row">
    <button id="roundAndRound" class="pill orange">Round and Round</button>
    <button id="pinkSoldiers" class="pill purple">Pink Soldiers</button>
    <button id="wayBack" class="pill blue">Way Back Then</button>
    <button id="accomplished" class="pill grey">Accomplished</button>
</div>

<script>

  const sounds = {
    greenLight: new Audio('sounds/doll_green_light.mp3'),
    redLight: new Audio('sounds/doll_red_light.mp3'),
    dollMusic: new Audio('sounds/doll_music.mp3'),
    dollMusicRus: new Audio('sounds/doll_music_rus.mp3'),
    scan: new Audio('sounds/scan.mp3'),
    round: new Audio('sounds/round_and_round.mp3'),
    pink: new Audio('sounds/pink_soldiers.mp3'),
    way: new Audio('sounds/way_back_then.mp3'),
    accomplished: new Audio('sounds/accomplished.mp3')
  };

  let scanTimer = null;
  const SCAN_PROBABILITY = 0.75;
  const SCAN_MIN = 3;

  sounds.round.loop = sounds.pink.loop = sounds.way.loop = true;

  Object.values(sounds).forEach(a => a.load());

  function toggleSound(name) {
    const audio = sounds[name];
    if (!audio.paused) {
      audio.pause();
      audio.currentTime = 0;
      return;
    }
    for (const [key, a] of Object.entries(sounds)) {
      if (key !== name) {
        a.pause();
        a.currentTime = 0;
      }
    }
    audio.play().catch(console.error);
  }

  function stopAll() {
    if (scanTimer) {
      clearTimeout(scanTimer);
      scanTimer = null;
    }

    for (const a of Object.values(sounds)) {
      a.onended = null;
      a.pause();
      a.currentTime = 0;
    }
    speechSynthesis.cancel();
  }


  function randomRate() {
    return 1 + Math.random() * 1.5;
  }

  function setRatePreservePitch(audio, rate) {
    console.log(rate);
    audio.playbackRate = rate;
    audio.preservesPitch = audio.webkitPreservesPitch = audio.mozPreservesPitch = true;
  }

  const btn = document.getElementById('playBtn');
  let timerId = null;
  let currentMusic = null;

  function setState(col) {
    btn.classList.toggle('red', col === 'red');
    btn.classList.toggle('green', col === 'green');
  }

  function startGreenPhase() {
    stopAll();
    setState('green');
    sounds.greenLight.play();
    const delay = 1300 + Math.random() * 3700;
    timerId = setTimeout(endGreenPhase, delay);
  }

  function endGreenPhase() {
    clearTimeout(timerId);
    timerId = null;
    stopAll();
    sounds.redLight.play();
    setState('red');
  }

  function playScanRandom() {
    const scan = sounds.scan;
    if (!scan) return setState('red');

    stopAll();
    currentMusic = 'scan';
    setState('green');

    // Wait for metadata so we know the full duration; fall back to 8 s if unknown
    const dur = (scan.duration && !isNaN(scan.duration)) ? scan.duration : 5;
    const slice = Math.random() * (dur - SCAN_MIN) + SCAN_MIN;

    scan.play().catch(console.error);

    // stop after the slice OR when the file ends naturally, whichever comes first
    scanTimer = setTimeout(() => {
      scan.pause();
      scan.currentTime = 0;
      scanTimer = null;
      setState('red');
      currentMusic = null;
    }, slice * 1000);

    scan.onended = () => {
      if (scanTimer) {
        clearTimeout(scanTimer);
        scanTimer = null;
      }
      currentMusic = null;
      setState('red');
    };
  }

  function playDollMusic(key) {
    stopAll();
    currentMusic = key;

    const track = sounds[key];
    const rate  = randomRate();        // pick it once

    setState('green');

    // run this first so it's ready whenever the clip really ends
    track.onended = () => {
      currentMusic = null;
      setRatePreservePitch(track, 1);

      // 75% chance of Scan
      if (Math.random() < SCAN_PROBABILITY) {
        playScanRandom();
      } else {
        setState('red');
      }
    };

    // Safari/Chrome‑mobile quirk: change playbackRate *after* play() begins
    track.play()
      .then(() => setRatePreservePitch(track, rate))
      .catch(err => {
        console.error('Could not start audio', err);
        // roll back UI so users aren’t stuck in green
        currentMusic = null;
        setState('red');
      });
  }



  btn.onclick = () => {
    if (btn.classList.contains('red')) {
      const rnd = Math.floor(Math.random() * 3);
      if (rnd === 0) {
        startGreenPhase()
      }
      else if (rnd === 1) {
        playDollMusic('dollMusic')
      }
      else {
        playDollMusic('dollMusicRus')
      }
    } else {
      if (timerId) endGreenPhase();
      if (currentMusic) {
        stopAll();
        currentMusic = null;
        setState('red');
      }
    }
  };

  const display = document.getElementById('numDisplay');
  let digits = '';

  function tweakNumberToken(token) {
    let num = token.replace(/^0+/, "");
    if (num === "") num = "0";

    if (/^\d{3}$/.test(num)) {
      num = num[0] + " " + num.slice(1);
    }

    return num.replace(/0/g, "O");
  }

  function chooseBestVoice(lang = 'en-US') {
    return new Promise(resolve => {
      // wait until voices are available (Safari often needs this)
      const load = () => {
        const all = speechSynthesis.getVoices();
        if (!all.length) return setTimeout(load, 50);

        const primary = lang.split('-')[0];

        // 1) Remote voices (most natural in Chrome/Edge & Android)
        const remote = all.find(v => !v.localService && v.lang.startsWith(lang));
        if (remote) return resolve(remote);

        // 2) Hand‑picked favourites by brand / OS
        const preferredNames = [
          // Google TTS on Chrome / Android
          /^Google .* English/i,
          // Microsoft Neural voices on Windows / Edge
          /^Microsoft (Jenny|Aria|Guy).* Online/i,
          /^Microsoft .* English/i,
          // Apple high‑quality voices on macOS / iOS
          /^(Samantha|Саманта)$/i
        ];
        for (const rx of preferredNames) {
          const v = all.find(v => rx.test(v.name) && v.lang.startsWith(primary));
          if (v) return resolve(v);
        }

        // 3) Browser‑flagged default for the exact language
        const langDefault = all.find(v => v.default && v.lang.startsWith(lang));
        if (langDefault) return resolve(langDefault);

        // 4) Any voice for the same primary language (en‑*)
        const samePrimary = all.find(v => v.lang.startsWith(primary));
        if (samePrimary) return resolve(samePrimary);

        // 5) Give up – let the browser decide
        resolve(null);
      };
      load();
    });
  }

  async function speak(txt) {
    txt = tweakNumberToken(txt);

    const u = new SpeechSynthesisUtterance(`Player:  ${txt}...... Eliminated`);

    if (!speak._voice) speak._voice = await chooseBestVoice('en-US');
    if (speak._voice) u.voice = speak._voice;

    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  document.querySelectorAll('.num').forEach(btn => {
    btn.onclick = () => {
      digits = digits.length === 3 ? btn.dataset.digit
        : digits + btn.dataset.digit;
      display.textContent = digits;
      if (digits.length === 3) speak(digits);
    };
  });

  document.getElementById('clr').onclick = () => {
    digits = '';
    display.textContent = '';
  };
  display.onclick = () => {
    if (digits.length === 3) speak(digits);
  };

  document.getElementById('roundAndRound').addEventListener('click', () => {
    toggleSound('round');
  });
  document.getElementById('pinkSoldiers').addEventListener('click', () => {
    toggleSound('pink');
  });
  document.getElementById('wayBack').addEventListener('click', () => {
    toggleSound('way')
  });
  document.getElementById('accomplished').addEventListener('click', () => {
    toggleSound('accomplished')
  });

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .catch(err => console.error('SW register failed:', err));
  }
</script>
</body>
</html>
